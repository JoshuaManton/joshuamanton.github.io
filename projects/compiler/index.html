<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Untitled Compiler ::
        Joshua Manton
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="A toy compiler project I started working on mostly to learn how compilers work. Turns out they are complicated.
This compiler implements a recursive-descent parser to parse source code into a syntax tree, typechecks the syntax tree and enforces the semantic rules of the language, generates an intermediate representation of the instruction stream and does register allocation, translates this intermediate representation to bytecode, and executes the bytecode in a virtual machine."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/projects/compiler/" />





<link rel="stylesheet" href="/assets/style.css" />

<link rel="stylesheet" href="/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Untitled Compiler"/>
<meta name="twitter:description" content="A toy compiler project I started working on mostly to learn how compilers work. Turns out they are complicated.
This compiler implements a recursive-descent parser to parse source code into a syntax tree, typechecks the syntax tree and enforces the semantic rules of the language, generates an intermediate representation of the instruction stream and does register allocation, translates this intermediate representation to bytecode, and executes the bytecode in a virtual machine."/>



<meta property="og:title" content="Untitled Compiler" />
<meta property="og:description" content="A toy compiler project I started working on mostly to learn how compilers work. Turns out they are complicated.
This compiler implements a recursive-descent parser to parse source code into a syntax tree, typechecks the syntax tree and enforces the semantic rules of the language, generates an intermediate representation of the instruction stream and does register allocation, translates this intermediate representation to bytecode, and executes the bytecode in a virtual machine." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/projects/compiler/" />
<meta property="article:published_time" content="2020-09-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-09-13T00:00:00+00:00" /><meta property="og:site_name" content="Joshua Manton" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Joshua Manton</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Untitled Compiler</h1>
    <div class="post-meta">
      
        <span class="post-date">
           
        </span>

        
          
        
      

      


      
    </div>

    

    
      <figure class="post-cover">
        
          <img src="/img/compiler.png" alt="Untitled Compiler" />
        

        
      </figure>
    

    <div class="post-content">
      
      <p>A toy compiler project I started working on mostly to learn how compilers work. Turns out they are complicated.</p>
<p>This compiler implements a recursive-descent parser to parse source code into a syntax tree, typechecks the syntax tree and enforces the semantic rules of the language, generates an intermediate representation of the instruction stream and does register allocation, translates this intermediate representation to bytecode, and executes the bytecode in a virtual machine.</p>
<p>Given the following program:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> Vector3 {
    x: <span style="color:#66d9ef">int</span>;
    y: <span style="color:#66d9ef">int</span>;
    z: <span style="color:#66d9ef">int</span>;
}

proc factorial(n: <span style="color:#66d9ef">int</span>) <span style="color:#f92672">:</span> <span style="color:#66d9ef">int</span> {
    <span style="color:#66d9ef">if</span> (n <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
    }
    <span style="color:#66d9ef">return</span> n <span style="color:#f92672">*</span> factorial(n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
}

proc main() {
    var v: Vector3;
    v.x <span style="color:#f92672">=</span> factorial(<span style="color:#ae81ff">5</span>);
    v.y <span style="color:#f92672">=</span> factorial(<span style="color:#ae81ff">8</span>);
    v.z <span style="color:#f92672">=</span> factorial(<span style="color:#ae81ff">13</span>);
}
</code></pre></div><p>Here is a visualization of the output of the parsing stage:</p>
<p>(todo)</p>
<p>Here is the bytecode output of the IR translation stage:</p>
<pre><code>factorial:
  ; save caller frame and return address
    push rfp
    push ra
  ; setup stack frame
    mov rfp rsp
    addi rsp rsp -4
  ; body
  ; IR_Load
    addi rt rfp -4
    load32 r1 rt
  ; IR_Move_Immediate
    movi r2 1
  ; IR_Binop
    eq r3 r1 r2
  ; IR_If
    gotoifz r3 if_ 28
  ; IR_Move_Immediate
    movi r3 1
  ; IR_Return
  ; return
    addi rsp rsp 4
    pop ra
    pop rfp
    push r3
    mov rip ra
if_ 28:
  ; IR_Load
    addi rt rfp -4
    load32 r3 rt
  ; IR_Call
    push r3
  ; IR_Load
    addi rt rfp -4
    load32 r1 rt
  ; IR_Move_Immediate
    movi r2 1
  ; IR_Binop
    sub r4 r1 r2
    addi rt rsp -20
    store32 rt r4
    jump factorial
    pop r4
    pop r3
  ; IR_Binop
    mul r1 r3 r4
  ; IR_Return
  ; return
    addi rsp rsp 4
    pop ra
    pop rfp
    push r1
    mov rip ra
  ; return
    addi rsp rsp 4
    pop ra
    pop rfp
    mov rip ra
main:
  ; save caller frame and return address
    push rfp
    push ra
  ; setup stack frame
    mov rfp rsp
    addi rsp rsp -12
  ; body
  ; IR_Call
  ; IR_Move_Immediate
    movi r1 5
    addi rt rsp -20
    store32 rt r1
    jump factorial
    pop r1
  ; IR_Store
    addi rt rfp -4
    store32 rt r1
  ; IR_Call
  ; IR_Move_Immediate
    movi r1 8
    addi rt rsp -20
    store32 rt r1
    jump factorial
    pop r1
  ; IR_Store
    addi rt rfp -8
    store32 rt r1
  ; IR_Call
  ; IR_Move_Immediate
    movi r1 13
    addi rt rsp -20
    store32 rt r1
    jump factorial
    pop r1
  ; IR_Store
    addi rt rfp -12
    store32 rt r1
  ; special sauce for main()
    addi rsp rsp 12
    exit
</code></pre>
    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="/projects/mathy-robot-guy/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Untitled Puzzle Game</span>
                </a>
              </span>
            
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Joshua Manton</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span
          >© 2020 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
        <span
          >Theme created by
          <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span
        >
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
